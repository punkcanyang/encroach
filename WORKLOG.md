# Encroach - 工作日报 (Worklog)

> 本文件用于记录每次较长段落、功能或任务完成后的工作进展。

## 2026-02-27

### 工作内容：项目理解与规则梳理
- **探索与解读架构**：阅读了核心文档 `ARCHITECTURE.md`、`TODO.md` 与 `DEVELOPMENT_GUIDELINES.md`，深度了解了“通过条件而非指令驱动的人类扩张系统模拟”这一游戏哲学。
- **当前进度确认**：确认项目目前完成了时间系统 (TimeSystem)、人类实体基础生命循环 (饥饿、寿命、自动寻食) 和初步的世界构建。
- **核心缺失分析**：分析了目前系统的心脏 `RuleEvaluator` 的代码实现，发现现阶段只有一个空壳框架（`load_default_rules`为空）。提炼出系统缺失的五个核心规则维度：
  1. 行为意图评估规则（Agent自身需求触发条件与权重）
  2. 环境场影响规则（建筑如何改变周围Agent的权重）
  3. 建筑放置与转化规则
  4. 人口与繁衍自然规则
  5. 资源再生与分布规律
- **文档产出**：
  - 补充了项目根目录下的 **README.md**。
  - 创建了 **WORKLOG.md** 以便后续追踪进展，符合 AI First 开发工作流的要求。

### 规则设计产出：填充生态循环漏洞
- **【规则集1】意图驱动**：采用无上限累积的线性模型 `(100-饥饿)*倍率`，且满 80 后不再主动寻食。
- **【规则集2】非食物类优先级**：饱腹(`>=80`)前提下才可挖掘非食物矿石，且系统动态比对全局存量，优先触发“当前最缺资源”的意图。
- **【规则集3】农田脉冲引力与范围衰减**：农田成熟达100%瞬间爆发出极强的觅食引力，引力只在建筑半径内有效并呈距离递减（距中心越近影响越强）。
- **【规则集4】繁殖衍生机制**：各个住所独立按10年循环产出人口，新生儿不凭空生成，而是固定在**空位最多的住所处**实体化。
- **【规则集5】野生矿物的降级消亡**：极其硬核的消亡机制。前期野生食物点一次性；贵金属矿尽后原址降级为工业金属矿，直到降级为土矿后最终挖空消失。极大地增加了早期资源紧缺的压迫感。
- **【规则集6&7】实体物流与生命循环（高维度模拟）**：
  - 加载了 Health(生命值) 设定，饥饿归 0 后不是秒死，而是扣除HP，死后身上携带的资源掉落为包裹。
  - **真实建造**：蓝图需要释放引力吸引 Agent 来实地敲打才能增加进度。
  - **真实仓储**：除了吃饭瞬间消耗，任何矿产被开采后，必须由 Agent 实体步行搬运进“当前有空位的住所”，才算入全局可用库存。拆除返还50%也同样适用于该物流规则。
- **【规则集8】核心点题：蚕食与战争扩张**：
  - **领地声索场**：军事/高级建筑产生辐射场，排斥非本族采集。
  - **异族 AI (竞争者)**：存在由同样参数驱动的敌对族群，争夺有限资源。
  - **碰撞即战争**：在领土交叉或争夺同一个高级矿点时，判定基础 Health 点数与建筑提供的武力 Buff 光环进行死斗，胜者留存，败者化作资源包。
  - **终极目标**：利用建筑的领地辐射和资源挤压，物理上“蚕食（Encroach）”整片大陆并灭绝异族。

### 下一步计划：
核心系统蓝图与所有基础运行规则已经彻底闭环并录入 [TODO.md](TODO.md) 中。下一步将正式进入**编码阶段（Execution）**。

### 修复：物件悬停信息 (Hover Info) 显示缺失的问题
- **问题分析**：`InspectUI` 原本只遍历 `World` 节点的直接子节点来检测鼠标悬停。而在架构调整后，`HumanAgent` 等实体被放在了管理器节点（如 `AgentManager`）之下，导致遍历不到。
- **解决方案**：引入 Godot 的 Node Group（节点组）机制。在 `Cave`、`Resource` 和 `HumanAgent` 实体中加入 `add_to_group("inspectable")`，并修改 `InspectUI` 通过 `get_tree().get_nodes_in_group("inspectable")` 来精准获取所有可检视对象，解决了信息不显示的问题，并且提高了后续添加新实体的扩展性。

### 重构：多资源类型分离系统
- **需求**：将原本只处理食物的单一资源流转改造为 FOOD/DIRT/IND_METAL/PREC_METAL 四种资源独立的搬运、储存、消耗管线。
- **变更范围**（7 个文件）：
  1. **`ResourceTypes.gd`** [新建]：全局共享 class_name 枚举，包含类型定义、翻译键、图标和工具方法
  2. **`Cave.gd`**：`stored_food: int` → `storage: Dictionary`，每种资源独立上限 100，保留向后兼容接口
  3. **`HumanAgent.gd`**：`CarriedResource` 枚举 → `carried_type: int`，新增规则集2 采集优先级（饱腹≥80 才采非食物）
  4. **`ResourceManager.gd`**：按类型分类统计野外资源与采集量
  5. **`StatsPanel.gd`**：分别显示 🍎/🪨/⚙️/💎 各类库存
  6. **`InspectUI.gd`**：山洞面板展示全部库存，Agent 面板展示携带资源类型
### 修复：InspectUI 悬停信息不显示
- **问题分析**：`InspectUI` 挂载在 `UIManager`（CanvasLayer）下，`get_viewport().get_camera_2d()` 返回 `null`，导致坐标转换失败。
- **解决方案**：改用 `get_tree().root.get_camera_2d()` 和 `get_tree().root.get_mouse_position()` 直接从根 Viewport 获取。

### 修复：采集优先级逻辑
- **问题**：储满的资源类型仍被采集；食物低时继续采矿物。
- **解决方案**：`_should_collect_type()` 增加三层判断：
  1. 山洞对应类型已满 → 跳过
  2. 食物库存 < 50% → 禁止采非食物
  3. 饱腹 < 80 → 禁止采非食物


