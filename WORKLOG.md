# Encroach - 工作日报 (Worklog)

> 本文件用于记录每次较长段落、功能或任务完成后的工作进展。

## 2026-02-27

### 工作内容：项目理解与规则梳理
- **探索与解读架构**：阅读了核心文档 `ARCHITECTURE.md`、`TODO.md` 与 `DEVELOPMENT_GUIDELINES.md`，深度了解了“通过条件而非指令驱动的人类扩张系统模拟”这一游戏哲学。
- **当前进度确认**：确认项目目前完成了时间系统 (TimeSystem)、人类实体基础生命循环 (饥饿、寿命、自动寻食) 和初步的世界构建。
- **核心缺失分析**：分析了目前系统的心脏 `RuleEvaluator` 的代码实现，发现现阶段只有一个空壳框架（`load_default_rules`为空）。提炼出系统缺失的五个核心规则维度：
  1. 行为意图评估规则（Agent自身需求触发条件与权重）
  2. 环境场影响规则（建筑如何改变周围Agent的权重）
  3. 建筑放置与转化规则
  4. 人口与繁衍自然规则
  5. 资源再生与分布规律
- **文档产出**：
  - 补充了项目根目录下的 **README.md**。
  - 创建了 **WORKLOG.md** 以便后续追踪进展，符合 AI First 开发工作流的要求。

### 规则设计产出：填充生态循环漏洞
- **【规则集1】意图驱动**：采用无上限累积的线性模型 `(100-饥饿)*倍率`，且满 80 后不再主动寻食。
- **【规则集2】非食物类优先级**：饱腹(`>=80`)前提下才可挖掘非食物矿石，且系统动态比对全局存量，优先触发“当前最缺资源”的意图。
- **【规则集3】农田脉冲引力与范围衰减**：农田成熟达100%瞬间爆发出极强的觅食引力，引力只在建筑半径内有效并呈距离递减（距中心越近影响越强）。
- **【规则集4】繁殖衍生机制**：各个住所独立按10年循环产出人口，新生儿不凭空生成，而是固定在**空位最多的住所处**实体化。
- **【规则集5】野生矿物的降级消亡**：极其硬核的消亡机制。前期野生食物点一次性；贵金属矿尽后原址降级为工业金属矿，直到降级为土矿后最终挖空消失。极大地增加了早期资源紧缺的压迫感。
- **【规则集6&7】实体物流与生命循环（高维度模拟）**：
  - 加载了 Health(生命值) 设定，饥饿归 0 后不是秒死，而是扣除HP，死后身上携带的资源掉落为包裹。
  - **真实建造**：蓝图需要释放引力吸引 Agent 来实地敲打才能增加进度。
  - **真实仓储**：除了吃饭瞬间消耗，任何矿产被开采后，必须由 Agent 实体步行搬运进“当前有空位的住所”，才算入全局可用库存。拆除返还50%也同样适用于该物流规则。
- **【规则集8】核心点题：蚕食与战争扩张**：
  - **领地声索场**：军事/高级建筑产生辐射场，排斥非本族采集。
  - **异族 AI (竞争者)**：存在由同样参数驱动的敌对族群，争夺有限资源。
  - **碰撞即战争**：在领土交叉或争夺同一个高级矿点时，判定基础 Health 点数与建筑提供的武力 Buff 光环进行死斗，胜者留存，败者化作资源包。
  - **终极目标**：利用建筑的领地辐射和资源挤压，物理上“蚕食（Encroach）”整片大陆并灭绝异族。

### 下一步计划：
核心系统蓝图与所有基础运行规则已经彻底闭环并录入 [TODO.md](TODO.md) 中。下一步将正式进入**编码阶段（Execution）**。

### 修复：物件悬停信息 (Hover Info) 显示缺失的问题
- **问题分析**：`InspectUI` 原本只遍历 `World` 节点的直接子节点来检测鼠标悬停。而在架构调整后，`HumanAgent` 等实体被放在了管理器节点（如 `AgentManager`）之下，导致遍历不到。
- **解决方案**：引入 Godot 的 Node Group（节点组）机制。在 `Cave`、`Resource` 和 `HumanAgent` 实体中加入 `add_to_group("inspectable")`，并修改 `InspectUI` 通过 `get_tree().get_nodes_in_group("inspectable")` 来精准获取所有可检视对象，解决了信息不显示的问题，并且提高了后续添加新实体的扩展性。

### 重构：多资源类型分离系统
- **需求**：将原本只处理食物的单一资源流转改造为 FOOD/DIRT/IND_METAL/PREC_METAL 四种资源独立的搬运、储存、消耗管线。
- **变更范围**（7 个文件）：
  1. **`ResourceTypes.gd`** [新建]：全局共享 class_name 枚举，包含类型定义、翻译键、图标和工具方法
  2. **`Cave.gd`**：`stored_food: int` → `storage: Dictionary`，每种资源独立上限 100，保留向后兼容接口
  3. **`HumanAgent.gd`**：`CarriedResource` 枚举 → `carried_type: int`，新增规则集2 采集优先级（饱腹≥80 才采非食物）
  4. **`ResourceManager.gd`**：按类型分类统计野外资源与采集量
  5. **`StatsPanel.gd`**：分别显示 🍎/🪨/⚙️/💎 各类库存
  6. **`InspectUI.gd`**：山洞面板展示全部库存，Agent 面板展示携带资源类型

### 修复：InspectUI 悬停信息不显示
- **问题分析**：`InspectUI` 挂载在 `UIManager`（CanvasLayer）下，`get_viewport().get_camera_2d()` 返回 `null`，导致坐标转换失败。
- **解决方案**：改用 `get_tree().root.get_camera_2d()` 和 `get_tree().root.get_mouse_position()` 直接从根 Viewport 获取。

### 修复：采集优先级逻辑
- **问题**：储满的资源类型仍被采集；食物低时继续采矿物。
- **解决方案**：`_should_collect_type()` 增加三层判断：
  1. 山洞对应类型已满 → 跳过
  2. 食物库存 < 50% → 禁止采非食物
  3. 饱腹 < 80 → 禁止采非食物

### 修复：建筑错位显示与升级阻塞
- **问题分析**：老版本 `InspectUI` 把所有带库存对象都按“鸭子类型”强行为视为 `Cave` 导致建筑名字张冠李戴，同时玩家反馈木屋无法升级，由于底层逻辑设计失误引起了吞噬物资 Bug。
- **解决方案**：
  1. 改用物理基因组 `building_type` 精准加载格式器，各司其职，消灭跨物种乱码认领。
  2. **【防吞机制】**重写了 `PlayerController.gd` 里面的消费逻辑，由先扣钱后申请放置，分离成了“先检查全域物资 -> 申请原址放置 -> 放置成功后真实扣款”的安全三步走。
  3. **【防撞体积豁免】**在 `BuildingManager.gd` 中增加了专供“原址升级”的豁免检定，建筑升级膨胀不再受四周树木和小人的挤压判定而强行终止，家园顺利通向向摩天大楼。

### 优化：解决 AI 群挤扎堆问题（黑板锁定系统）
- **问题分析**：由于 `HumanAgent` 目标分配时全员共享相同的“距离阈值”最短路径视野，导致同时爆发需求（如农田产出）时，几十个小人叠在一块冲向同一目标，冗余行走大大降低集镇运作效率。
- **解决方案**：引入了基于 `meta(reserved_count)` 注册的黑板占位机制（Blackboard Reservation）。
  1. **多级并发限制**：设定野生矿点 (`MAX_RESERVERS_WILD = 1`) 不许围观；农场 (`FARM = 2`) 允许两人下地；在建蓝图 (`BLUEPRINT = 3`) 允许三人同敲。
  2. **智能分流避险**：在底层 `_find_and_move_to_nearest_resource` 的雷达循环中植入关卡。如果发现物理距离最近的苹果树**已被占满**，系统将强制蒙蔽当前 Agent 对该树的感知，促使其走向远处的备选点位，实现了极其优雅的宏观防扎堆群落分工计算。

## 2026-02-28

### 优化：解决高级建筑导致的人口涨幅滞缓
- **问题分析**：此前，全局的人口增长“按时间自动产妇”逻辑被死死绑定在了出生的唯一节点 `Cave` 身上，定死为 `SPAWN_INTERVAL_DAYS = 3650 (10年)`。导致玩家不管在后期造了多少座满载 150 人的大楼，全世界只有最初的那个山洞能每隔10年蹦出一个人。这造成了“小镇越繁华，出生率反而大幅暴跌”的致命失真。
- **解决方案**：我将繁衍的“时间发条”下放到了所有继承自 `Residence.gd` 的居住类模型里。
  1. 通过在 `BUILDING_DATA` 中引入随等级下降的 `spawn_interval_days`（例如：山洞10年，木屋8年，石屋5年，大厦1年）。
  2. 当 `TimeSystem` 中的日子越迁，全地图**所有有效住宅**都会并发计算其肚子里的计时器。若达到自身孕期并且其内部能抽调出 `FOOD_COST_PER_HUMAN = 50`，那么这栋楼就会随机选向四方自动生产一名新生儿。真正实现了以楼为基座的指数级几何人口大爆炸！
### 优化：美化详细建筑与资源信息面板（InspectUI）
- **问题分析**：玩家反馈点击高阶住宅时的信息面板（如石屋）极度拥挤丑陋，各项文本（上限光环、库存容量、升级要求）全部挤在没有行距的白色统一字号内，连大号的升级底栏按钮也因字数过多而粘连。
- **解决方案**：我重构了 `InspectUI.gd` 中用于排版的单体控件。
  1. **升级为富文本组件**：将主体显示框 `_content_label` 从原先的死板 `Label` 大换血为 `RichTextLabel` 并强制开启 `bbcode_enabled = true`。
  2. **注入色彩与多格式间距 (BBCode)**：使用 `[color=#aaddff]` 及 `[b]` 将属性奖励进行点亮处理。废弃硬编码的 `\n\n\n` 换行拼接，转而使用 `──── 库存物资 ────` 等带色精致分割线，使得区块一目了然。
  3. **升级按钮行距重构**：专门加高了 `_upgrade_btn` 的控件尺寸 Y，并将密密麻麻的五金建材升级条件做成了带醒目标题 `─ 需求建材 ─` 的多行等宽段落列表。视觉上再无压抑感。

### 新机制：【规则集6】实体生老病死与动态寿命体系、遗物包裹系统
- **问题分析**：之前游戏内的小人为长生不死状态（饥饿掉 0 仅瞬杀），后期容易导致人口臃肿。其次，正在搬运矿产的小人突然死亡会导致手头物资永久蒸发，缺乏生存后勤体验。同时，玩家提出小人的寿命应当与社会当时的房屋科技上限相挂钩。
- **解决方案**：完整实装“生命循环”功能：
  1. **独立 Health 血条与饿肚子流血**：`HumanAgent` 不再因饥饿立刻被引擎消灭。当 `hunger <= 0` 时，每天执行 `hp -= 5.0`。只有当 `hp <= 0` 时才会真正饿死。
  2. **动态科技寿命 `lifespan_days`**：重写了 `AgentManager.gd` 中的 `add_agent` 函数。新生的 Agent 寿命将取决于目前世界现存的最高级房屋（例如只有山洞则只能活 10~20年，建出大楼的新人则可延至 30~80年）。当在世时间超过这个动态锚定的天数时触发“寿终正寝”。
  3. **遗产化作 `ResourceDrop` 实体**：当任何 Agent 彻底死亡 (`_die`) 时，立刻检查它 `carried_amount` 是否有货。如果有，在死亡坐标呼叫 Manager 动态生成一个新的鸭子节点 `ResourceDrop.gd`。
  4. **全自动同类拾荒**：将打包好的 `ResourceDrop` 节点塞入 `resource` 分组，并在其中写入了 `collect` 和 `is_depleted` 方法。完美骗过了活着的 Agent 的扫描雷达。因此活着的小人在周围没果子时会第一时间冲向死去的同伴吸取包裹里的营养或矿石！

## 2026-03-01

### 修复：人口生育彻底失效与生命流逝体验缓慢问题
- **问题分析**：玩家反馈繁殖机制疑似未生效。排查发现两个核心问题：
  1. **时间尺度异常**：原先规定 1年=365天，山洞 10年一胎 意味着 3650 个 Tick，玩家实际需要挂机 2 小时才能看到第一个新生儿。
  2. **全局同步怀孕 Bug**：所有建筑用全局 `current_day % interval` 求余，导致多栋房子同一天集体爆兵。
- **解决方案**：
  1. 为 `Cave.gd` 和 `Residence.gd` 各自增加 `_days_active` 独立计时器，用该局部计时器代替全局天数求余。
  2. 将 `DAYS_PER_YEAR` 从 365 压缩至 **10**，同步调整 `BuildingManager.BUILDING_DATA` 中所有 `spawn_interval_days`（山洞:100, 木屋:80, 石屋:50, 大楼:10）。
  3. 将 `AgentManager.add_agent` 中寿命乘数从 `*365` 改为 `*10`。
- **效果**：玩家现在挂机几分钟即可观察到完整的代际更替（出生、繁荣、老死、遗物掉落）。
