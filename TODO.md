# Encroach - 开发任务清单

> 项目愿景：一个你无法直接指挥的族群生态系统；你只能通过建筑与规则影响它

---

## 核心系统 (Core Systems)

### TimeSystem - 时间推进系统 ✅ DONE
- [x] Tick 循环 (0.5秒 = 1 Tick)
- [x] Day 循环 (10 Ticks = 1 Day)
- [x] 信号发射 (tick_passed, day_passed)

### AgentManager - 族群管理器 ✅ DONE
- [x] Agent 实例化与销毁
- [x] Agent 数量限制
- [x] 初始 Agent 生成

### ResourceManager - 资源管理器 ✅ DONE
- [x] 全局资源统计管理（按类型分类）
- [x] 食物消耗接口
- [x] 库存变化信号
- [x] 多资源类型独立统计（FOOD/DIRT/IND_METAL/PREC_METAL）

### BuildingManager - 建筑管理器 🔄 IN PROGRESS
- [x] 建筑蓝图定义 (BuildingPlan)
- [x] 建筑实例管理 (BuildingInstance)
- [x] 建筑放置验证
- [x] 建筑升级系统 (采用增量独立放置提升全局上限体系)
- [ ] 建筑影响场计算

### RuleEvaluator - 规则评估器 🔄 IN PROGRESS
- [x] 基础框架
- [ ] 【规则集1】行为意图评估规则
  - [ ] 饥饿触发觅食意图：权重 = (100 - hunger) * 倍率 (上限吃饱阈值 hunger>=80 时为 0)
- [ ] 【规则集3】建筑环境与引力规则
  - [ ] 农田脉冲引力：农田按 Tick 自动积累生长度。成熟度达 100% 时，瞬间爆发极高“觅食引力权重”。
  - [ ] 空间距离衰减判定：建筑引力仅在自身半径 R 内有效。距离越近（距中心点），提供的额外权重越大；超出半径的 Agent 感知不到该建筑的引力。
- [ ] 建筑建造条件评估 (空间严苛验证：建筑为实体几何，不可与资源、Agent或其他建筑重叠)
- [ ] 建筑对 Agent 权重影响 (作为基础 Modifier 系统)
- [ ] 全局规则检查

---

## 实体系统 (Entity Systems)

### HumanAgent - 人类实体 ✅ DONE/🔄 IN PROGRESS
- [x] _draw() 绘制外观 (白色圆圈)
- [x] 饥饿系统 (每 Tick -3, 上限 100)
- [x] 【规则集6】实体生老病死：
  - [x] 生命值系统 (Health 点数) 与动态老死大限。当饥饿降至 0 时扣除生命点数，根据出生时全局最高建筑种类赋予先天寿命 (10-80年)。
  - [x] 死亡物质掉落 (ResourceDrop) 与同类拾荒回收。
- [x] 自动觅食 (饥饿 < 60 时)
- [x] 状态机基础框架
- [x] 移动系统 (游走、寻路)
  - [x] **优化点**：解决 AI 扎堆拥堵执行同一目标的问题 (如引入黑板系统或目标预占位机制)
- [ ] 资源采集 (移动到资源点)
- [ ] 行为权重系统 (受建筑影响)
- [x] 繁殖/生育系统 (已修复高级建筑人口增速反降的问题，实现分级住宅并发化生产)

### Resource - 资源实体 ✅ DONE/🔄 IN PROGRESS
- [x] _draw() 绘制外观 (绿色方块)
- [x] 资源类型枚举 (FOOD, DIRT, IND_METAL, PREC_METAL)
  - [ ] 设定：精简为4大基础资源。**水和木材不作为独立生存资源**以减轻前期寻路与循环负担。
- [x] 储量管理
- [x] 采集接口
- [ ] 【规则集5】野生资源枯竭与降级机制：
  - [ ] 野生食物/土矿：一次性消耗。挖完即永久消失。（后期通过核心建筑如农田、牧场、深井矿解决持续性产出）
  - [ ] 高级矿物降级：
    - [ ] 贵金属矿挖空后 -> 原地转变为“野生工业金属矿”
    - [ ] 工业金属矿挖空后 -> 原地转变为“野生土矿”
- [ ] 【规则集2】多资源采集与优先级规则：
  - [x] 前置条件：Agent 饥饿度需 >= 80（即相对饱腹状态）才允许开采非食物资源
  - [x] 储满跳过：山洞对应类型已满时，不再采集该类型
  - [x] 食物优先：山洞食物库存 < 50% 时，禁止采集非食物资源
  - [ ] 优先级逻辑：优先采集当前库存中最缺的资源

---

## 建筑系统 (Building System)

### 建筑类型定义 🔄 IN PROGRESS
- [x] 住所体系 (提供人口上限 & 资源存储上限，采用独立放置增量累加机制)：
  - [x] **山洞 (Cave)**: 6人上限 | 储物上限：100 各资源，山洞只能储存食物和土矿 (基础核心)，建造需要80个土矿，50个食物，创建后，自带增加一个人类人口
  - [x] **木屋 (Wooden Hut)**: +15人上限 | 储物上限：+500，可储存食物，土矿，工业金属 ，建造需要200个土矿，100个食物，可由山洞升级，资源可扣除山洞的资源，创建后，自带增加2个人类人口
  - [x] **石屋 (Stone House)**: +24人上限 | 储物上限：+2000，可储存食物，土矿，工业金属，贵金属 ，建造需要500个土矿，200个食物，200个工业金属，可由木屋升级，资源可扣除木屋的资源，创建后，自带增加3个人类人口
  - [x] **大楼 (Residence Building)**: +144人上限 | 储物上限：+5000 ，可储存食物，土矿，工业金属，贵金属 ，建造需要1000个土矿，500个食物，500个工业金属，200个贵金属，可由石屋升级，资源可扣除石屋的资源，创建后，自带增加10个人类人口
- [x] 生产建筑体系 (提供资源采集，【基于使用的自动熟练度系统】)：
  - [x] **农田 (Farm)**: 建造需要100个土矿，50个食物，随 Agent 的反复收割（交互人次 `total_work_count`），农田逐渐积累熟练度经验，从而提升每次单次收割的食物产量与生长速度。
- [ ] 军备与异族建筑体系：
  - [ ] 瞭望塔 (扩大领土辐射范围，可攻击靠近的敌人或是野兽，但每次攻击只能损伤1HP)，需要300个土矿，100个工业金属，50个贵金属，需要消耗一个人口驻守
  - [ ] 兵营 (提供人口上限 & 资源存储上限，采用独立放置增量累加机制)：

### 建筑机制 🔄 IN PROGRESS
- [x] 建筑蓝图数据格式 (JSON/Dictionary)
- [x] 建筑建造条件规则：
  - [x] 资源扣除匹配
  - [x] 空间实体碰撞检测（必须满足不与任何 Agent、基础资源点、已有建筑重叠）
- [ ] 建筑影响场可视化 (圆圈范围)
- [x] 建筑升级路径 (山洞 -> 木屋 -> 石屋 -> 大楼 增量体系)
- [ ] 建筑耐久度与维护
- [ ] 建筑耐久度与维护

---

### 玩家交互与建造规则 🔄 IN PROGRESS
- [x] 【规则集7】建筑生命周期与物流机制：
  - [x] **蓝图引力与施工**：玩家放置蓝图（扣除全局虚拟预扣配额）。蓝图产生“施工引力场”，吸引 Agent 靠近并持续“敲锤子”（投入交互时长）。当进度 100% 后转为正式建筑。
  - [ ] **建筑拆除与返还**：建筑不可移动。拆除建筑时，返还 50% 建造资源（直接入库或原地掉落包裹）。
  - [ ] **硬核搬运物流**：除了进食瞬间消耗资源无需回家，矿场等其他资源挖掘后，采集者必须身上携带实体资源，移动步行回“当前有对应存储空位的住所”存放。放入住所的瞬间，该资源才正式计入全局面板可用库存。
- [x] 鼠标点击拆除/新建机制 (当前进度：按B键，可左键新建)
- [x] 放置预览 (有效/无效物理重叠区域)
- [x] 建造进度条渲染

### UI 系统 ⏳ TODO
- [x] **优先修复**：修复 `InspectUI` 悬停失效的问题（在 `UIManager.gd` 中补充通过纯代码 `Node.new()` 的实例化挂载流程）
- [ ] 资源显示 (食物、人口、天数)
- [ ] Agent 统计面板
- [ ] 建筑选择面板
- [ ] 系统日志/事件记录

---

## 世界生成 (World Generation)

### 地图系统 ✅ DONE
- [x] 世界大小定义 (2400×1800)
- [x] 视窗与地图分离 (Camera2D)
- [x] 相机移动控制 (WASD/方向键)
- [x] 边界限制 (Agent & 资源)
- [x] 地图可视化 (边界框、网格)

### WorldGenerator ✅ DONE
- [x] 地图配置数据 (大小、边界)
- [x] 随机资源生成 (10-20个食物点)
- [x] 初始 Agent 分布 (地图中心区域)
- [x] 边界碰撞检测
- [ ] 地形类型生成 (草地、森林)

### 地形系统 🔄 FUTURE
- [ ] 基础地形类型 (草地、森林、水域)
- [ ] 地形对移动速度影响
- [ ] 资源分布与地形关联

### 初始世界设置 ✅ DONE
- [x] 随机生成初始资源点
- [x] 设置初始 Agent 数量
- [x] 初始食物库存配置

---

## 游戏机制 (Game Mechanics)

### 人口系统 ⏳ TODO
- [ ] 人口上限 (由当前住所级别合计决定)
- [ ] 【规则集4】繁殖与人口增长机制：
  - [ ] 自然增长：每个住所独立计时，固定每十年（Day）增加一个人。
  - [ ] 空间生成逻辑：新生儿直接实体化于**当前拥有最多空位（上限减去已入住人数）的住所坐标点**，然后开始生命循环。
  - [ ] 前置约束：全局必须判定为“有充足食物”才支持新生人口孵化。

### 资源循环 ⏳ TODO
- [ ] 食物采集 -> 消耗 -> 死亡的完整循环
- [ ] 资源点自然再生
- [ ] 资源点枯竭后的新资源生成

### 失败条件 ✅ DONE (已实现)
- [x] 全部 Agent 饿死 -> 游戏结束
- [x] 正常结局提示

### 【Encroach】扩张与侵略机制 🔄 FUTURE
> 这是游戏名字“蚕食/侵蚀”的核心体现。随着族群生存的稳定，对于地盘和矿产的贪婪将引发跨物种/跨部落的系统级冲突。
- [ ] 【规则集8】领地与异族战争：
  - [ ] **领地声索场 (Territory Control)**：玩家的军事建筑（如瞭望塔、哨站）和高级住所会向外散发“领地辐射”。在这个辐射场内，禁止非本族群 Agent 采集资源。
  - [ ] **AI 异族群落地**：地图边缘或生成时，存在由另一套底层参数运转的异族（如野兽群、哥布林或其他部落）。他们同样受饥饿和寿命驱动。
  - [ ] **资源争夺触发战争**：当异族的“饥饿采集引力”或“游走意图”使其进入玩家的领地声索场，或者玩家的人为了远方高级矿产走入异族区时，触发【战斗意图】。
  - [ ] **战斗结算**：Agent 在相遇时，意图切换为“攻击”。此时比拼基础生命值(Health)与建筑提供的【武装熟练度/Buff】（例如铁匠铺提供的光环或者造价对应的武器派发）。战死者同样掉落资源包裹。
  - [ ] **种族灭绝/扩张胜利**：玩家通过建筑步步为营，如同“癌细胞”一样把领地辐射场覆盖全图，并从物理上抹杀所有竞争型异族。

### 胜利条件 🔄 FUTURE
- [ ] 扩张胜利：玩家的领地辐射场覆盖超过地图 80%，并消灭初始存在的所有异族巢穴。
- [ ] 生存胜利（可选）：存活达到指定天数并达到最高级人口要求。

---

## 视觉与表现 (Visuals)

### 当前阶段 (MVP) ✅ DONE
- [x] Agent: 白色实心圆 (半径 4)
- [x] 资源: 绿色方块 (大小 6)
- [x] 饥饿危急: 红色圆
- [x] 控制台日志输出

### 增强视觉 ⏳ TODO
- [ ] 建筑几何图形表示
- [ ] 影响范围半透明圆圈
- [ ] Agent 状态文字标签
- [ ] 资源储量数字显示

### 未来美术 🔄 FUTURE
- [ ] 像素风格 Sprites
- [ ] 动画系统
- [ ] 粒子效果
- [ ] 昼夜光照变化

---

## 调试与工具 (Debug & Tools)

### 调试功能 ⏳ TODO
- [ ] 时间速度控制 (暂停/快进)
- [ ] Agent 状态实时查看
- [ ] 建筑影响场 Debug 显示
- [ ] 性能监控 (FPS, 实体数量)

### 作弊指令 ⏳ TODO
- [ ] 添加食物
- [ ] 生成 Agent
- [ ] 强制推进时间
- [ ] 重置世界

---

## 技术债务 (Technical Debt)

### 代码优化 ⏳ TODO
- [ ] 完善错误处理 (null 检查)
- [ ] 信号断开清理
- [ ] 内存泄漏检查
- [ ] 单元测试

### 架构改进 🔄 FUTURE
- [ ] 保存/加载系统
- [ ] 配置文件外部化
- [ ] 模块化系统通信
- [ ] 事件总线 (Event Bus)

---

## 优先级说明

| 符号 | 含义 | 说明 |
|------|------|------|
| ✅ DONE | 已完成 | 功能已实现并通过测试 |
| 🔄 IN PROGRESS | 进行中 | 正在开发或部分实现 |
| ⏳ TODO | 待开发 | 下一阶段的开发目标 |
| 🔄 FUTURE | 未来 | MVP 之后的功能扩展 |

---

## 当前阶段目标 (MVP)

**核心循环验证：**
1. Agent 自动觅食、消耗、死亡 ✅
2. 建筑放置影响 Agent 行为 ⏳
3. 资源循环 (采集 -> 消耗 -> 死亡) ✅
4. 系统崩溃 = 正常结局 ✅

**下一步开发重点：**
1. [x] 实现建筑系统 (BuildingManager)
2. [x] 添加第一种建筑：农田 (提高采集效率)
3. [x] 实现玩家建筑放置交互
4. [ ] 完善 UI 显示资源状态

---

*最后更新: 2026-02-27*
